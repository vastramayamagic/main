<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vastramaya</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --page-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #3f0b17;
            --text-secondary: #6b422a;
            --brand-primary: #8b2635;
            --brand-secondary: #d33d49;
            --green-success: #4a9c7d;
            --border-subtle: #e8d5c4;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-main: 'DM Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--page-bg); font-family: var(--font-main); color: var(--text-primary); }

        /* Admin Navbar */
        .admin-nav {
            background: var(--brand-primary); color: white; height: 64px;
            display: flex; align-items: center; padding: 0 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
        }
        .nav-logo { font-weight: 700; font-size: 20px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; }
        .nav-badge { background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase; }

        /* Dashboard Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--card-bg); padding: 24px; border-radius: 12px;
            border: 1px solid var(--border-subtle); box-shadow: var(--shadow-card);
            display: flex; flex-direction: column;
        }
        .stat-label { font-size: 14px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--brand-primary); margin-top: 8px; }
        .stat-icon { align-self: flex-end; margin-top: -40px; font-size: 24px; color: var(--border-subtle); opacity: 0.5; }

        /* Filters */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .search-box { position: relative; width: 300px; }
        .search-input {
            width: 100%; padding: 10px 16px 10px 40px; border: 1px solid var(--border-subtle);
            border-radius: 8px; font-family: var(--font-main); outline: none;
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

        /* Orders Table */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-subtle); overflow: hidden; box-shadow: var(--shadow-card); }
        .orders-table { width: 100%; border-collapse: collapse; text-align: left; }
        
        .orders-table th { 
            background: #fdf2f4; padding: 16px 20px; font-weight: 600; font-size: 14px; 
            color: var(--brand-primary); border-bottom: 1px solid var(--border-subtle); 
        }
        .orders-table td { padding: 16px 20px; border-bottom: 1px solid #f0f0f0; font-size: 15px; vertical-align: middle; }
        .orders-table tr:last-child td { border-bottom: none; }
        .orders-table tr:hover { background: #fafafa; }

        /* Badges & text styles */
        .id-badge { font-family: monospace; font-weight: 700; color: var(--text-primary); background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 13px; }
        .status-select {
            padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-subtle);
            font-size: 13px; font-weight: 600; cursor: pointer; outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 10px; padding-right: 25px;
        }
        
        .status-Pending { background-color: #fffbeb; color: #b45309; border-color: #fcd34d; }
        .status-Paid { background-color: #ecfdf5; color: #047857; border-color: #6ee7b7; } /* Kept CSS for Paid just in case order comes in as Paid */
        .status-Shipped { background-color: #eff6ff; color: #1d4ed8; border-color: #93c5fd; }
        .status-Delivered { background-color: #f0fdf4; color: #15803d; border-color: #86efac; }
        .status-Cancelled { background-color: #fef2f2; color: #b91c1c; border-color: #fca5a5; }

        .method-badge { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .method-COD { color: var(--brand-secondary); }
        .method-Online { color: var(--green-success); }

        .btn-view {
            padding: 8px 16px; border: 1px solid var(--border-subtle); background: white;
            border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;
            font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-view:hover { border-color: var(--brand-primary); color: var(--brand-primary); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-card {
            background: white; width: 600px; max-width: 90vw; max-height: 85vh;
            border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .detail-group { margin-bottom: 24px; }
        .detail-label { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        
        .item-row { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .item-img { width: 70px; height: 90px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .item-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .item-info h4 { font-size: 16px; margin-bottom: 4px; color: var(--text-primary); }
        .item-meta { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid #ccc; margin-left: 4px; vertical-align: middle; }

        .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); }

        @media (max-width: 768px) {
            .orders-table thead { display: none; }
            .orders-table, .orders-table tbody, .orders-table tr, .orders-table td { display: block; width: 100%; }
            .orders-table tr { margin-bottom: 15px; border: 1px solid var(--border-subtle); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .orders-table td { text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid #eee; }
            .orders-table td::before { 
                content: attr(data-label); position: absolute; left: 15px; top: 16px;
                font-weight: 600; font-size: 13px; color: var(--text-secondary);
            }
        }
    </style>
</head>
<body>

    <nav class="admin-nav">
        <div class="nav-logo">
            <i class="fas fa-shield-alt"></i>
            Vastramaya <span class="nav-badge">Admin</span>
        </div>
        <div style="margin-left: auto;">
            <button class="btn-view" onclick="window.location.href='index.html'" style="background: rgba(255,255,255,0.1); border:none; color: white;">
                <i class="fas fa-external-link-alt"></i> Go to Store
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Total Revenue</span>
                <span class="stat-value" id="stat-revenue">₹0</span>
                <i class="fas fa-coins stat-icon"></i>
            </div>
            <div class="stat-card">
                <span class="stat-label">Total Orders</span>
                <span class="stat-value" id="stat-orders">0</span>
                <i class="fas fa-shopping-bag stat-icon"></i>
            </div>
            <div class="stat-card">
                <span class="stat-label">Pending Orders</span>
                <span class="stat-value" id="stat-pending" style="color: var(--brand-secondary);">0</span>
                <i class="fas fa-clock stat-icon"></i>
            </div>
        </div>

        <!-- Filters -->
        <div class="toolbar">
            <h2 style="font-size: 22px;">Recent Orders</h2>
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search Order ID or Name..." onkeyup="filterOrders()">
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-body">
                    <tr><td colspan="7" style="text-align:center;">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modal-title">Order Details</h3>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="detail-group">
                    <div class="detail-label">Shipping Address</div>
                    <div id="modal-address" style="line-height: 1.5; font-size: 15px;"></div>
                </div>
                
                <div class="detail-group">
                    <div class="detail-label">Items Ordered</div>
                    <div id="modal-items"></div>
                </div>

                <div class="detail-group" style="display:flex; justify-content:space-between; border-top:1px dashed #ccc; padding-top:15px; margin-bottom:0;">
                    <strong>Total Amount</strong>
                    <strong style="color:var(--brand-primary); font-size: 18px;" id="modal-total"></strong>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCdeonH3VytC21F3X6x0rCVCn2xXrGPoug",
            authDomain: "vastramaya---magic.firebaseapp.com",
            projectId: "vastramaya---magic",
            storageBucket: "vastramaya---magic.firebasestorage.app",
            messagingSenderId: "543460072082",
            appId: "1:543460072082:web:f3d1140e8f81ad338ae44b",
            measurementId: "G-E39VNDCFVE"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allOrders = []; 

        document.addEventListener('DOMContentLoaded', () => {
            db.collection('orders')
              .orderBy('createdAt', 'desc')
              .limit(50)
              .onSnapshot((snapshot) => {
                  allOrders = [];
                  let totalRevenue = 0;
                  let pendingCount = 0;

                  snapshot.forEach(doc => {
                      const data = doc.data();
                      data.id = doc.id;
                      allOrders.push(data);
                      
                      totalRevenue += (data.amount || 0);
                      
                      // LOGIC UPDATE: Count as pending unless Delivered or Cancelled
                      if(data.paymentStatus !== 'Delivered' && data.paymentStatus !== 'Cancelled') {
                          pendingCount++;
                      }
                  });

                  updateStats(allOrders.length, totalRevenue, pendingCount);
                  renderTable(allOrders);
              }, (error) => {
                  console.error("Error fetching orders:", error);
                  document.getElementById('orders-body').innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Error loading orders. Check console.</td></tr>`;
              });
        });

        function renderTable(orders) {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = '';

            if(orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No orders found.</td></tr>`;
                return;
            }

            orders.forEach(order => {
                const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString("en-IN") : 'Just now';
                const status = order.paymentStatus || 'Pending';
                const method = order.paymentMethod || 'Online';
                const customerName = order.address ? order.address.name : 'Guest';

                // LOGIC UPDATE: 'Paid' removed from dropdown options.
                // It will only be selected if the order explicitly has that status from DB.
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Order ID"><span class="id-badge">#${order.orderId}</span></td>
                    <td data-label="Date">${date}</td>
                    <td data-label="Customer"><strong>${customerName}</strong><br><span style="font-size:12px; color:#666;">${order.address?.phone || ''}</span></td>
                    <td data-label="Amount" style="font-weight:700;">₹${(order.amount || 0).toLocaleString('en-IN')}</td>
                    <td data-label="Payment"><span class="method-badge method-${method}">${method}</span></td>
                    <td data-label="Status">
                        <select onchange="updateStatus('${order.id}', this.value)" class="status-select status-${status}">
                            <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Shipped" ${status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Cancelled" ${status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            ${status === 'Paid' ? '<option value="Paid" selected>Paid</option>' : ''} 
                        </select>
                    </td>
                    <td data-label="Actions">
                        <button class="btn-view" onclick='viewDetails("${order.id}")'>
                            <i class="fas fa-eye"></i> Details
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats(count, revenue, pending) {
            document.getElementById('stat-orders').innerText = count;
            document.getElementById('stat-revenue').innerText = `₹${revenue.toLocaleString('en-IN')}`;
            document.getElementById('stat-pending').innerText = pending;
        }

        async function updateStatus(docId, newStatus) {
            try {
                const selectEl = document.querySelector(`select[onchange*="${docId}"]`);
                selectEl.className = `status-select status-${newStatus}`;
                
                await db.collection('orders').doc(docId).update({
                    paymentStatus: newStatus
                });
            } catch (error) {
                alert("Error updating status: " + error.message);
            }
        }

        function filterOrders() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allOrders.filter(o => 
                (o.orderId && o.orderId.toLowerCase().includes(term)) || 
                (o.address && o.address.name && o.address.name.toLowerCase().includes(term))
            );
            renderTable(filtered);
        }

        function viewDetails(docId) {
            const order = allOrders.find(o => o.id === docId);
            if (!order) return;

            document.getElementById('modal-title').innerText = `Order #${order.orderId}`;
            document.getElementById('modal-total').innerText = `₹${(order.amount || 0).toLocaleString('en-IN')}`;

            const addr = order.address;
            const addrHtml = addr ? 
                `<strong>${addr.name}</strong> (${addr.type || 'Home'})<br>
                 ${addr.street}<br>
                 ${addr.locality}, ${addr.city}<br>
                 ${addr.state} - ${addr.zip}<br>
                 Phone: ${addr.phone}` : 'No Address Data';
            document.getElementById('modal-address').innerHTML = addrHtml;

            // LOGIC UPDATE: Show Color and Image
            const itemsContainer = document.getElementById('modal-items');
            itemsContainer.innerHTML = '';
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const colorHtml = item.color ? `<span style="margin-left:8px;">Color: <strong>${item.color}</strong></span>` : '';
                    
                    itemsContainer.innerHTML += `
                        <div class="item-row">
                            <img src="${item.image}" class="item-img" onerror="this.src='https://via.placeholder.com/70x90?text=No+Img'">
                            <div class="item-info">
                                <h4>${item.name}</h4>
                                <div class="item-meta">
                                    <span>Qty: ${item.quantity}</span>
                                    ${item.size ? '<span>| Size: ' + item.size + '</span>' : ''}
                                    ${colorHtml}
                                </div>
                                <div style="font-weight:600; margin-top:4px;">₹${item.price}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                itemsContainer.innerHTML = '<p>No items found.</p>';
            }

            document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>

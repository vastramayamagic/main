<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vastramaya | Premium E-commerce</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-height-desktop: 80px;
            --navbar-height-mobile: 70px;
            --page-bg: #fefcf3;
            --text-primary: #3f0b17;
            --text-secondary: #6b422a;
            --text-light: #a3715f;
            --brand-primary: #8b2635;
            --brand-secondary: #d33d49;
            --brand-gradient: linear-gradient(135deg, #8b2635 0%, #d33d49 100%);
            --progress-color: #8b2635;
            --progress-bg: rgba(59, 11, 23, 0.15);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(139, 38, 53, 0.1);
            --circle-bg: #fff9f0;
            --circle-border: #e8d5c4;
            --border-subtle: #e8d5c4;
            --surface-light: #fff9f0;
            --surface-card: #fffefb;
            --surface-hover: #f9f2e3;
            --product-card-bg: #fffefb;
            --success-color: #4a9c7d;
            --shadow-premium: 0 10px 25px -5px rgba(59, 11, 23, 0.1), 0 5px 10px -5px rgba(59, 11, 23, 0.04);
            --shadow-light: 0 2px 10px rgba(59, 11, 23, 0.05);
            --shadow-medium: 0 8px 30px rgba(59, 11, 23, 0.12);
            --shadow-modal: 0 25px 50px -12px rgba(63, 11, 23, 0.25);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { min-height: 100vh; background: var(--page-bg); font-family: "DM Sans", Roboto, sans-serif; overflow-x: hidden; color: var(--text-primary); width: 100%; }

        .page-desktop { min-height: 100vh; display: flex; flex-direction: column; width: 100%; }
        
        .d-navbar { height: var(--header-height-desktop); background: var(--surface-card); border-bottom: 1px solid var(--border-subtle); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: var(--shadow-light); }
        .d-navbar-container { max-width: 1440px; margin: 0 auto; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; }
        .d-navbar-logo { height: 60px; width: auto; object-fit: contain; }
        
        .d-nav-links { display: flex; align-items: center; gap: 32px; margin: 0 40px; }
        .d-nav-link { font-size: 15px; font-weight: 600; color: var(--text-primary); text-decoration: none; padding: 8px 0; position: relative; transition: color 0.2s ease; white-space: nowrap; }
        .d-nav-link:hover, .d-nav-link.active { color: var(--brand-primary); }
        .d-nav-link.active::after { content: ''; position: absolute; bottom: -4px; left: 0; right: 0; height: 2px; background: var(--brand-primary); border-radius: 1px; }

        .d-categories-dropdown { position: relative; }
        .d-categories-content { position: absolute; top: 100%; left: -20px; background: var(--surface-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 12px 0; min-width: 220px; box-shadow: var(--shadow-premium); opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; z-index: 100; }
        .d-categories-dropdown:hover .d-categories-content { opacity: 1; visibility: visible; transform: translateY(0); }
        .d-category-item { display: block; padding: 12px 24px; color: var(--text-primary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
        .d-category-item:hover { background: var(--surface-hover); color: var(--brand-primary); padding-left: 28px; }

        .d-search-container { flex: 1; max-width: 400px; position: relative; }
        .d-search-bar { width: 100%; padding: 12px 16px 12px 44px; border: 1px solid var(--border-subtle); border-radius: 10px; background: var(--surface-light); font-family: "DM Sans", sans-serif; font-size: 14px; color: var(--text-primary); outline: none; transition: all 0.2s ease; }
        .d-search-bar:focus { background: var(--surface-card); border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(139, 38, 53, 0.1); }
        .d-search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-light); width: 18px; height: 18px; }

        .d-action-icons { display: flex; align-items: center; gap: 20px; }
        .d-icon-btn { position: relative; width: 40px; height: 40px; border-radius: 10px; background: var(--surface-light); border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; text-decoration: none; color: inherit; }
        .d-icon-btn:hover { background: var(--surface-hover); border-color: var(--brand-primary); transform: translateY(-1px); }
        .d-icon-btn svg { width: 20px; height: 20px; stroke: var(--text-primary); stroke-width: 1.5; transition: stroke 0.2s ease; }
        .d-icon-btn:hover svg { stroke: var(--brand-primary); }

        .cart-badge, .wishlist-badge { position: absolute; top: -6px; right: -6px; background: var(--brand-primary); color: white; font-size: 11px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--surface-card); }

        .d-profile-dropdown { position: relative; }
        .d-profile-btn { width: 44px; height: 44px; border-radius: 12px; overflow: hidden; border: 2px solid var(--border-subtle); cursor: pointer; transition: all 0.2s ease; }
        .d-profile-btn:hover { border-color: var(--brand-primary); transform: translateY(-1px); }
        .d-profile-img { width: 100%; height: 100%; object-fit: cover; }

        .profile-popup { position: absolute; top: calc(100% + 10px); right: 0; background: var(--surface-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 20px; min-width: 280px; box-shadow: var(--shadow-premium); opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; z-index: 1000; }
        .profile-popup.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .profile-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle); }
        .profile-info { flex: 1; }
        .profile-name { font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 4px; }
        .profile-email { font-size: 14px; color: var(--text-light); }
        .profile-links { display: flex; flex-direction: column; gap: 8px; }
        .profile-link { display: flex; align-items: center; padding: 12px 16px; color: var(--text-primary); text-decoration: none; border-radius: 10px; font-weight: 500; transition: all 0.2s ease; cursor: pointer; }
        .profile-link:hover { background: var(--surface-hover); color: var(--brand-primary); padding-left: 20px; transform: translateX(2px); }
        .admin-link-btn { background-color: var(--text-primary); color: white !important; border: 1px solid var(--text-primary); }
        .admin-link-btn:hover { background-color: transparent; color: var(--text-primary) !important; }
        
        .auth-hidden { display: none !important; }

        .cart-popup { position: absolute; top: calc(100% + 10px); right: 0; background: var(--surface-card); border: 1px solid var(--border-subtle); border-radius: 16px; width: 420px; max-height: 520px; box-shadow: var(--shadow-premium); opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; z-index: 1000; display: flex; flex-direction: column; overflow: hidden; }
        .cart-popup.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .cart-popup-header { padding: 20px; border-bottom: 1px solid var(--border-subtle); background: var(--surface-light); flex-shrink: 0; }
        .cart-popup-title { font-weight: 700; font-size: 18px; color: var(--text-primary); margin-bottom: 4px; }
        .cart-popup-subtitle { font-size: 14px; color: var(--text-light); }
        .cart-popup-body { flex: 1; overflow-y: auto; padding: 0; min-height: 280px; max-height: 280px; }
        .cart-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-subtle); gap: 16px; transition: all 0.2s ease; position: relative; }
        .cart-item:hover { background: var(--surface-hover); }
        .cart-item-img { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border-subtle); }
        .cart-item-details { flex: 1; min-width: 0; }
        .cart-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cart-item-price { font-weight: 700; font-size: 15px; color: var(--brand-primary); }
        .cart-item-quantity { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .quantity-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; color: var(--text-primary); }
        .quantity-btn:hover { border-color: var(--brand-primary); color: var(--brand-primary); background: var(--surface-card); }
        .quantity-value { font-weight: 600; min-width: 24px; text-align: center; font-size: 14px; color: var(--text-primary); }
        .cart-item-remove { position: absolute; top: 16px; right: 16px; width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light); }
        .cart-item-remove:hover { background: #fef2f2; border-color: #fecaca; color: #ef4444; }
        .cart-popup-footer { padding: 20px; border-top: 1px solid var(--border-subtle); background: var(--surface-card); box-shadow: 0 -2px 10px rgba(59, 11, 23, 0.05); flex-shrink: 0; }
        .cart-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle); }
        .cart-total-label { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .cart-total-amount { font-weight: 700; font-size: 22px; color: var(--brand-primary); }
        .buy-btn { width: 100%; padding: 14px; background: var(--brand-gradient); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .buy-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 38, 53, 0.3); }
        .empty-cart-msg { text-align: center; padding: 2rem; color: var(--text-light); }

        .d-content { flex: 1; background: var(--page-bg); overflow-y: auto; width: 100%; padding-top: var(--header-height-desktop); margin-top: 0; }

        .hero-section { width: 100%; position: relative; overflow: hidden; margin-top: 0; height: 85vh; min-height: 700px; max-height: 900px; background: var(--page-bg); }
        .carousel-container { position: relative; width: 100%; height: 100%; overflow: hidden; margin: 0 auto; box-shadow: var(--shadow-medium); }
        .carousel-track { display: flex; height: 100%; transition: transform 1s cubic-bezier(0.33, 1, 0.68, 1); }
        .carousel-slide { flex: 0 0 100%; height: 100%; position: relative; overflow: hidden; }
        .slide-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: transform 12s ease-out; }
        .carousel-slide.active .slide-image { transform: scale(1.08); }
        .glass-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(254, 252, 243, 0.1) 0%, rgba(254, 252, 243, 0.05) 50%, rgba(254, 252, 243, 0.1) 100%); z-index: 1; }

        .progress-indicators { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 10; padding: 12px 20px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 100px; box-shadow: var(--shadow-light); }
        .progress-indicator { width: 50px; height: 3px; background: var(--progress-bg); border-radius: 2px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-indicator:hover { transform: scaleY(1.5); background: rgba(139, 38, 53, 0.25); }
        .progress-indicator.active { background: transparent; }
        .progress-fill { position: absolute; top: 0; left: 0; width: 0%; height: 100%; background: var(--progress-color); border-radius: 2px; }
        .progress-indicator.active .progress-fill { animation: fillProgress 5s linear forwards; }
        @keyframes fillProgress { from { width: 0%; } to { width: 100%; } }

        .carousel-nav { position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); display: flex; justify-content: space-between; padding: 0 30px; z-index: 10; pointer-events: none; }
        .nav-arrow { width: 50px; height: 50px; border-radius: 50%; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: auto; opacity: 0; transform: translateX(-15px); }
        .carousel-container:hover .nav-arrow { opacity: 1; transform: translateX(0); }
        .nav-arrow:hover { background: rgba(139, 38, 53, 0.1); border-color: rgba(139, 38, 53, 0.2); transform: scale(1.1) !important; box-shadow: var(--shadow-light); }
        .nav-arrow.next { transform: translateX(15px); }
        .carousel-container:hover .nav-arrow.next { transform: translateX(0); }
        .nav-arrow svg { width: 24px; height: 24px; stroke: var(--text-primary); stroke-width: 2; }

        .best-sellers-section, .category-products-section, .categories-section { padding: 30px 40px; background: var(--page-bg); max-width: 1600px; margin: 0 auto; }
        .categories-section { padding: 10px 40px; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0; }
        .section-header h2 { font-size: 32px; font-weight: 700; color: var(--text-primary); position: relative; margin: 0; }
        .section-header h2::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 50px; height: 3px; background: var(--brand-primary); border-radius: 2px; }
        
        .section-header-right { display: flex; align-items: center; gap: 20px; }
        .view-more-link { font-size: 14px; font-weight: 600; color: var(--brand-primary); text-decoration: none; transition: all 0.2s; white-space: nowrap; border-bottom: 1px solid transparent; }
        .view-more-link:hover { border-bottom-color: var(--brand-primary); }

        .section-nav, .new-arrivals-nav { display: flex; gap: 12px; }
        .nav-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--product-card-bg); border: 1px solid var(--circle-border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-btn:hover { background: var(--brand-primary); border-color: var(--brand-primary); transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .nav-btn:hover svg { stroke: white; }
        .nav-btn svg { width: 20px; height: 20px; stroke: var(--text-primary); stroke-width: 2; transition: stroke 0.3s ease; }
        .nav-btn.disabled { opacity: 0.3; cursor: not-allowed; }

        .products-container { position: relative; overflow: hidden; }
        .products-grid { display: flex; gap: 25px; padding: 10px 5px 30px; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; scroll-snap-type: x mandatory; }
        .products-grid::-webkit-scrollbar { display: none !important; }

        .product-card { flex: 0 0 auto; width: 300px; background: var(--product-card-bg); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-light); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); scroll-snap-align: start; border: 1px solid var(--circle-border); position: relative; cursor: pointer; }
        .product-card:hover { box-shadow: var(--shadow-medium); border-color: var(--brand-primary); }
        .product-image-container { position: relative; width: 100%; height: 320px; overflow: hidden; border-bottom: 1px solid var(--circle-border); }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease, transform 0.8s ease; }
        .default-image { opacity: 1; transform: scale(1); }
        .hover-image { opacity: 0; transform: scale(1.05); }
        .product-card:hover .default-image { opacity: 0; transform: scale(1.05); }
        .product-card:hover .hover-image { opacity: 1; transform: scale(1); }
        
        .quick-view-btn { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(139, 38, 53, 0.95); color: white; padding: 12px 20px; border: none; font-family: "DM Sans", sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 2; }
        .quick-view-btn:hover { background: rgba(139, 38, 53, 1); }
        .quick-view-btn svg { width: 16px; height: 16px; stroke: white; }
        .product-card:hover .quick-view-btn { transform: translateY(0); }

        .product-info { padding: 15px; min-height: 110px; }
        .product-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; line-height: 1.3; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .product-category { font-size: 12px; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; height: 16px; overflow: hidden; }
        .product-price { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .price-container { display: flex; align-items: center; gap: 8px; }
        .current-price { font-size: 18px; font-weight: 700; color: var(--brand-primary); }
        .old-price { font-size: 14px; font-weight: 500; color: var(--text-light); text-decoration: line-through; }
        
        .wishlist-btn-top-right { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-subtle); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; z-index: 10; transition: all 0.2s ease; }
        .wishlist-btn-top-right:hover { transform: scale(1.1); background: #fff; }
        .wishlist-btn-top-right svg { width: 18px; height: 18px; stroke: var(--brand-primary); fill: none; }

        .add-to-cart { width: 40px; height: 40px; border-radius: 10px; background: var(--circle-bg); border: 1px solid var(--circle-border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 5; }
        .add-to-cart:hover { background: var(--brand-primary); border-color: var(--brand-primary); }
        .add-to-cart:hover svg { stroke: white; }
        .add-to-cart svg { width: 20px; height: 20px; stroke: var(--text-primary); stroke-width: 1.5; transition: stroke 0.3s ease; }

        .categories-section .section-title { text-align: center; font-size: 32px; font-weight: 700; margin-bottom: 30px; color: var(--text-primary); position: relative; }
        .categories-section .section-title::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: var(--brand-primary); border-radius: 2px; }
        
        .categories-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 25px; justify-content: center; max-width: 1200px; margin: 0 auto; }
        .category-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .category-circle { width: 140px; height: 140px; border-radius: 50%; background: var(--circle-bg); border: 2px solid var(--circle-border); display: flex; align-items: center; justify-content: center; margin-bottom: 15px; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-light); }
        .category-circle img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .category-name { font-size: 16px; font-weight: 600; color: var(--text-primary); text-align: center; transition: color 0.3s ease; line-height: 1.4; padding: 0 5px; }
        .category-item:hover .category-circle { transform: translateY(-8px); border-color: var(--brand-primary); box-shadow: var(--shadow-medium); }
        .category-item:hover .category-circle img { transform: scale(1.1); }
        .category-item:hover .category-name { color: var(--brand-primary); }

        .page-mobile { min-height: 100vh; display: flex; flex-direction: column; display: none; width: 100%; }
        .m-navbar { height: var(--navbar-height-mobile); background: var(--surface-card); border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: var(--shadow-light); }
        .m-menu-btn { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s ease; z-index: 2; min-width: 40px; }
        .m-menu-btn:hover { background: var(--surface-hover); }
        .m-menu-lines { width: 18px; height: 14px; position: relative; }
        .m-menu-lines::before, .m-menu-lines::after, .m-menu-lines span { content: ""; position: absolute; left: 0; right: 0; height: 2px; border-radius: 999px; background: var(--text-primary); }
        .m-menu-lines::before { top: 0; }
        .m-menu-lines span { top: 6px; }
        .m-menu-lines::after { bottom: 0; }
        .m-logo { height: 50px; width: auto; object-fit: contain; position: absolute; left: calc(42.5%); transform: translateX(-50%); }
        .m-right-icons { display: flex; align-items: center; gap: 12px; z-index: 2; min-width: 92px; justify-content: flex-end; }
        .m-icon-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--surface-light); border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .m-icon-btn:hover { background: var(--surface-hover); }
        .m-icon-btn svg { width: 20px; height: 20px; stroke: var(--text-primary); stroke-width: 1.5; }
        .mobile-cart-badge, .mobile-wishlist-badge { position: absolute; top: -4px; right: -4px; background: var(--brand-primary); color: white; font-size: 10px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--surface-card); }

        .m-content { flex: 1; background: var(--page-bg); padding-top: var(--navbar-height-mobile); padding-bottom: 20px; width: 100%; overflow-x: hidden; margin-top: 0; }
        .m-content-inner { padding: 0; max-width: 100%; }

        .m-overlay { position: fixed; inset: 0; background: rgba(59, 11, 23, 0.3); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.25s ease-out; z-index: 2000; }
        .m-overlay.open { opacity: 1; pointer-events: auto; }
        .m-drawer { position: absolute; left: 0; top: 0; width: 320px; max-width: 90vw; height: 100%; background: var(--surface-card); display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.25s ease-out; overflow-y: auto; box-shadow: 2px 0 20px rgba(59, 11, 23, 0.1); }
        .m-overlay.open .m-drawer { transform: translateX(0); }
        
        .m-drawer-header { height: 72px; min-height: 72px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: var(--surface-card); position: relative; z-index: 10; }
        .m-drawer-logo { height: 50px; width: auto; object-fit: contain; display: block; }
        .m-drawer-close { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s ease; }
        .m-drawer-close:hover { background: var(--surface-hover); }
        .m-drawer-close-icon { width: 14px; height: 14px; position: relative; }
        .m-drawer-close-icon::before, .m-drawer-close-icon::after { content: ""; position: absolute; inset: 0; margin: auto; width: 14px; height: 2px; border-radius: 999px; background: var(--text-primary); }
        .m-drawer-close-icon::before { transform: rotate(45deg); }
        .m-drawer-close-icon::after { transform: rotate(-45deg); }

        .m-drawer-nav { padding: 20px 0; display: flex; flex-direction: column; flex: 1; overflow-y: auto; }
        .nav-section { padding: 0 0 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-subtle); }
        .nav-section:last-child { border-bottom: none; margin-bottom: 0; }
        .nav-section-title { padding: 0 24px 12px; font-size: 13px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .m-nav-link { display: flex; align-items: center; height: 48px; padding: 0 24px; margin: 2px 0; color: var(--text-primary); text-decoration: none; font-size: 16px; font-weight: 500; transition: background 0.15s ease; border-radius: 0; }
        .m-nav-link:hover { background: var(--surface-hover); }
        .m-nav-link.active { color: var(--brand-primary); background: linear-gradient(135deg, #fdf2f4 0%, #fbe9eb 100%); border-right: 3px solid var(--brand-primary); }

        .m-categories-dropdown { margin: 2px 0; }
        .m-categories-toggle { display: flex; align-items: center; justify-content: space-between; height: 48px; padding: 0 24px; color: var(--text-primary); font-size: 16px; font-weight: 500; cursor: pointer; transition: background 0.15s ease; border-radius: 0; }
        .m-categories-toggle:hover { background: var(--surface-hover); }
        .m-categories-toggle.active { color: var(--brand-primary); background: linear-gradient(135deg, #fdf2f4 0%, #fbe9eb 100%); }
        .m-categories-toggle .chevron { width: 16px; height: 16px; stroke: var(--text-light); transition: transform 0.2s ease; }
        .m-categories-toggle.active .chevron { stroke: var(--brand-primary); transform: rotate(90deg); }
        .m-categories-content { display: none; margin-left: 28px; padding-left: 16px; border-left: 2px solid var(--border-subtle); margin-top: 4px; margin-bottom: 8px; }
        .m-categories-content.show { display: block; }
        .m-category-item { display: block; height: 44px; padding: 0 24px; color: var(--text-light); text-decoration: none; font-size: 15px; font-weight: 400; border-radius: 8px; transition: all 0.15s ease; display: flex; align-items: center; }
        .m-category-item:hover { background: var(--surface-hover); color: var(--brand-primary); }

        .m-drawer-profile { padding: 20px 24px; border-top: 1px solid var(--border-subtle); background: linear-gradient(135deg, var(--surface-light) 0%, var(--surface-hover) 100%); margin-top: auto; flex-shrink: 0; cursor: pointer; position: relative; }
        .m-profile-header { display: flex; align-items: center; gap: 12px; }
        .m-profile-img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; border: 2px solid var(--surface-card); box-shadow: 0 2px 8px rgba(59, 11, 23, 0.1); }
        .m-profile-info { flex: 1; }
        .m-profile-name { font-weight: 700; font-size: 16px; color: var(--text-primary); margin-bottom: 4px; }
        .m-profile-email { font-size: 14px; color: var(--text-light); }
        .m-login-text { font-weight: 600; color: var(--brand-primary); font-size: 16px; }

        .m-profile-popup-menu {
            position: absolute;
            bottom: 100%;
            left: 20px;
            right: 20px;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 8px;
            box-shadow: var(--shadow-modal);
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 12px;
            z-index: 200;
        }
        .m-profile-popup-menu.active { display: flex; animation: slideUpFade 0.2s ease-out; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .m-profile-option {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        .m-profile-option:hover { background: var(--surface-hover); color: var(--brand-primary); }
        .m-profile-option.logout { color: #d33d49; }
        .m-profile-option.logout:hover { background: #fff1f2; }


        .m-search-overlay { position: fixed; inset: 0; background: var(--surface-card); z-index: 4000; display: none; flex-direction: column; }
        .m-search-header { height: 72px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; padding: 0 16px; gap: 12px; }
        .m-search-input { flex: 1; padding: 14px; border: 1px solid var(--border-subtle); border-radius: 10px; font-family: "DM Sans", sans-serif; font-size: 16px; color: var(--text-primary); outline: none; background: var(--surface-light); }
        .m-search-close { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .cart-overlay { position: fixed; inset: 0; background: rgba(59, 11, 23, 0.3); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.25s ease-out; z-index: 3000; }
        .cart-overlay.open { opacity: 1; pointer-events: auto; }
        .cart-drawer { position: absolute; right: 0; top: 0; width: 380px; max-width: 90vw; height: 100%; background: var(--surface-card); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.25s ease-out; overflow-y: auto; box-shadow: -2px 0 20px rgba(59, 11, 23, 0.1); }
        .cart-overlay.open .cart-drawer { transform: translateX(0); }
        .cart-drawer-header { height: 72px; min-height: 72px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--surface-card); flex-shrink: 0; }
        .cart-drawer-title { font-weight: 700; font-size: 18px; color: var(--text-primary); }
        .cart-drawer-close { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-subtle); background: var(--surface-light); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .cart-drawer-close:hover { background: var(--surface-hover); }
        .cart-drawer-body { flex: 1; overflow-y: auto; padding: 0; min-height: 300px; }
        .cart-drawer-footer { padding: 20px; border-top: 1px solid var(--border-subtle); background: var(--surface-card); box-shadow: 0 -2px 10px rgba(59, 11, 23, 0.05); flex-shrink: 0; }
        .mobile-cart-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle); }
        .mobile-cart-total-label { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .mobile-cart-total-amount { font-weight: 700; font-size: 20px; color: var(--brand-primary); }
        .mobile-buy-btn { width: 100%; padding: 16px; background: var(--brand-gradient); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden; }
        .mobile-buy-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 38, 53, 0.3); }

        @media (max-width: 1024px) {
            .d-nav-links { gap: 20px; margin: 0 20px; }
            .d-search-container { max-width: 300px; }
            .categories-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .category-circle { width: 120px; height: 120px; }
        }

        @media (max-width: 768px) {
            .page-desktop { display: none; }
            .page-mobile  { display: flex; }
            .d-navbar-container { padding: 0 20px; }
            .cart-popup { width: 350px; }
            .hero-section { margin-top: 0; height: 75vh; min-height: 550px; max-height: 750px; }
            .desktop-image { display: none !important; }
            .mobile-image { display: block !important; }
            .progress-indicators { bottom: 20px; gap: 10px; padding: 10px 16px; }
            .progress-indicator { width: 35px; height: 2.5px; }
            .carousel-nav { padding: 0 15px; pointer-events: auto; }
            .nav-arrow { width: 40px; height: 40px; opacity: 1; transform: translateX(0) !important; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 38, 53, 0.2); }
            .carousel-slide.active .slide-image { transform: scale(1.05); }
            .best-sellers-section, .category-products-section { padding: 20px 10px; }
            .categories-section { padding: 5px 10px; }
            .section-header { padding: 0 10px; margin-bottom: 20px; }
            .section-header h2 { font-size: 24px; }
            .nav-btn { width: 44px; height: 44px; }
            .products-grid { gap: 15px; padding: 10px 5px 30px; }
            .product-card { width: 280px; }
            .product-image-container { height: 280px; }
            .product-info { padding: 12px; min-height: 100px; }
            .product-title { font-size: 15px; height: 36px; }
            .current-price { font-size: 18px; }
            .old-price { font-size: 13px; }
            .categories-grid { display: flex; grid-template-columns: none; gap: 20px; overflow-x: auto; padding: 20px 10px 40px; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; justify-content: flex-start; max-width: 100%; margin: 0; }
            .categories-grid::-webkit-scrollbar { display: none; }
            .category-item { flex: 0 0 auto; width: 110px; }
            .category-circle { width: 100px; height: 100px; }
            .category-name { font-size: 14px; }
            .section-title { font-size: 28px; margin-bottom: 20px; }
            .categories-container { position: relative; max-width: 100%; overflow: hidden; }
            .scroll-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; transition: all 0.3s ease; box-shadow: var(--shadow-light); }
            .scroll-arrow:hover { background: rgba(139, 38, 53, 0.1); border-color: var(--brand-primary); }
            .scroll-arrow.left { left: 10px; }
            .scroll-arrow.right { right: 10px; }
            .scroll-arrow svg { width: 20px; height: 20px; stroke: var(--text-primary); }
            .scroll-arrow.hidden { opacity: 0; pointer-events: none; }
            .quick-view-btn { display: none !important; }
            
            /* 2-column grid for newly added category sections ONLY */
            .category-products-section .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 0 10px; overflow-x: visible; }
            .category-products-section .product-card { width: 100%; flex: none; border-radius: 12px; }
            .category-products-section .product-image-container { height: 200px; }
            .category-products-section .product-actions-row { display: none !important; }
            .category-products-section .section-nav { display: none; }
            
            .best-sellers-section .product-card { width: 260px; }
            .best-sellers-section .product-image-container { height: 260px; }
            .category-products-section .product-image-container { height: 180px; }
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .carousel-slide { animation: slideIn 0.8s cubic-bezier(0.33, 1, 0.68, 1) forwards; }
        
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(139, 38, 53, 0.4); } 50% { box-shadow: 0 0 0 4px rgba(139, 38, 53, 0); } }
        
        @media (min-width: 1200px) { .best-sellers-section, .categories-section, .category-products-section { padding-left: 40px; padding-right: 40px; } }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(40, 10, 15, 0.6); backdrop-filter: blur(6px); z-index: 5000; opacity: 0; visibility: hidden; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content-box { background: var(--page-bg); width: 100%; max-width: 1200px; height: 90vh; border-radius: 20px; position: relative; box-shadow: var(--shadow-modal); transform: scale(0.95); opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content-box { transform: scale(1); opacity: 1; }
        .btn-close-modal { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: white; border-radius: 50%; border: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; z-index: 50; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-close-modal:hover { background: var(--brand-primary); color: white; border-color: var(--brand-primary); transform: rotate(90deg); }
        .btn-close-modal svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; }
        .modal-scroll-area { overflow-y: auto; height: 100%; width: 100%; }
        .modal-container { display: grid; grid-template-columns: 1.1fr 1fr; gap: 50px; align-items: start; padding: 50px; margin: 0 auto; }
        .gallery-wrapper { position: sticky; top: 0; display: flex; gap: 16px; height: 600px; }
        .thumbnails { display: flex; flex-direction: column; gap: 10px; width: 70px; flex-shrink: 0; overflow-y: auto; }
        .thumbnails::-webkit-scrollbar { width: 0; }
        .thumb { width: 70px; height: 94px; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid transparent; transition: all 0.3s; opacity: 0.6; flex-shrink: 0; }
        .thumb:hover { opacity: 1; }
        .thumb.active { opacity: 1; border-color: var(--brand-primary); }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .main-stage { flex: 1; height: 100%; border-radius: 12px; overflow: hidden; background: white; border: 1px solid var(--border-subtle); }
        .main-stage img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease; }
        .product-details { padding-top: 10px; }
        .product-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        .modal-product-title { font-size: 28px; line-height: 1.3; font-weight: 500; margin: 0; color: var(--text-primary); }
        .price-block { display: flex; align-items: baseline; gap: 12px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle); }
        .modal-price-current { font-size: 28px; font-weight: 600; color: var(--brand-primary); }
        .modal-price-old { font-size: 18px; color: var(--text-light); text-decoration: line-through; }
        .discount-badge { background: #fdf2f2; color: var(--brand-primary); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .option-label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary); margin-bottom: 10px; display: flex; justify-content: space-between; }
        .color-swatches { display: flex; gap: 10px; margin-bottom: 24px; }
        .swatch { width: 50px; height: 68px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; padding: 2px; overflow: hidden; }
        .swatch img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .swatch.active { border-color: var(--brand-primary); }
        .size-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 24px; }
        .size-btn { min-width: 48px; height: 44px; padding: 0 10px; background: white; border: 1px solid var(--border-subtle); border-radius: 8px; font-family: "DM Sans", sans-serif; font-size: 14px; font-weight: 500; color: var(--text-primary); transition: all 0.2s; cursor: pointer; }
        .size-btn:hover { border-color: var(--brand-primary); color: var(--brand-primary); }
        .size-btn.active { background: var(--brand-primary); border-color: var(--brand-primary); color: white; }
        .qty-wrapper { display: inline-flex; align-items: center; justify-content: space-between; background: white; border: 1px solid var(--border-subtle); border-radius: 8px; height: 44px; width: 130px; margin-bottom: 30px; }
        .qty-btn { width: 40px; height: 100%; background: transparent; border: none; font-size: 20px; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; }
        .qty-val { font-weight: 600; font-size: 15px; }
        .actions-desktop { display: flex; gap: 16px; margin-bottom: 30px; }
        .btn-main, .btn-secondary { height: 52px; border-radius: 10px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; cursor: pointer; }
        .btn-secondary { flex: 1; background: white; border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .btn-secondary:hover { border-color: var(--brand-primary); color: var(--brand-primary); background: var(--surface-hover); }
        .btn-main { flex: 1.5; background: var(--brand-gradient); color: white; border: none; box-shadow: 0 8px 20px rgba(139, 38, 53, 0.2); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(139, 38, 53, 0.3); }

        .mobile-gallery, .mobile-actions-bar { display: none; }

        @media (max-width: 1024px) {
            .modal-content-box { height: 95vh; width: 95vw; }
            .modal-container { padding: 30px; gap: 30px; }
            .gallery-wrapper { height: 450px; }
        }

        @media (max-width: 768px) {
            .modal-overlay { padding: 0; align-items: flex-end; }
            .modal-content-box { height: 85vh; width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; transform: translateY(100%); margin: 0; }
            .modal-overlay.active .modal-content-box { transform: translateY(0); }
            .btn-close-modal { top: 16px; right: 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); width: 36px; height: 36px; }
            .modal-container { display: block; padding: 0; padding-bottom: 90px; }
            .gallery-wrapper, .actions-desktop { display: none; }
            .mobile-gallery { display: flex; position: relative; width: 100%; height: 420px; background: #f5f5f5; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
            .mobile-gallery::-webkit-scrollbar { display: none; }
            .mobile-gallery img { min-width: 100%; height: 100%; object-fit: cover; object-position: top; scroll-snap-align: center; }
            .product-details { padding: 24px 20px; background: var(--page-bg); border-radius: 24px 24px 0 0; margin-top: -24px; position: relative; z-index: 2; }
            .modal-product-title { font-size: 20px; margin-bottom: 10px; }
            .modal-price-current { font-size: 22px; }
            .price-block { margin-bottom: 20px; border: none; padding-bottom: 0; }
            .mobile-actions-bar { display: flex; position: absolute; bottom: 0; left: 0; right: 0; background: white; padding: 12px 20px; gap: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 100; }
            .btn-mobile-cart { flex: 1; height: 48px; background: #fff5f6; color: var(--brand-primary); border: 1px solid rgba(139, 38, 53, 0.2); border-radius: 8px; font-weight: 600; cursor: pointer; }
            .btn-mobile-buy { flex: 1.2; height: 48px; background: var(--brand-gradient); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        }

        .promo-popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .promo-popup-content { background: white; width: 90%; max-width: 400px; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--shadow-modal); animation: popUp 0.4s ease; }
        @keyframes popUp { from {transform: scale(0.9); opacity:0;} to {transform: scale(1); opacity:1;} }
        .promo-close { position: absolute; top: 10px; right: 10px; background: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #ddd; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 6000; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideUp 0.3s ease; display: flex; align-items: center; gap: 1rem; border-left: 4px solid #8b2635; min-width: 300px; pointer-events: auto; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .auth-modal-content { 
            background: var(--page-bg); 
            width: 90%; 
            max-width: 400px; 
            border-radius: 20px; 
            box-shadow: var(--shadow-modal); 
            padding: 30px; 
            position: relative; /* Changed from fixed for better keyboard handling */
            transform: none; /* Reset transform */
            opacity: 0; 
            transition: opacity 0.3s ease;
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            max-height: 85vh; /* Keep some space */
            overflow-y: auto;
            margin: auto; /* Centers in flex container */
        }
        
        .modal-overlay.auth-active {
            display: flex; /* Ensure flex is active */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        
        .modal-overlay.auth-active .auth-modal-content { 
            opacity: 1; 
            transform: scale(1);
        }
        
        #authModal { align-items: center !important; }

        .auth-title { font-size: 24px; font-weight: 700; color: var(--text-primary); text-align: center; }
        .auth-subtitle { font-size: 14px; color: var(--text-light); text-align: center; margin-top: -10px; margin-bottom: 10px; }
        .auth-input-group { position: relative; width: 100%; }
        .auth-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--text-primary); font-size: 16px; }
        .auth-input { width: 100%; padding: 14px 16px; border: 1px solid var(--border-subtle); border-radius: 10px; background: var(--surface-light); font-size: 16px; font-family: "DM Sans", sans-serif; outline: none; transition: all 0.2s; }
        .auth-input.with-prefix { padding-left: 54px; }
        .auth-input:focus { border-color: var(--brand-primary); background: white; box-shadow: 0 0 0 3px rgba(139, 38, 53, 0.1); }
        .auth-btn { width: 100%; padding: 14px; background: var(--brand-gradient); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-btn:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 38, 53, 0.3); }
        .auth-step { display: none; flex-direction: column; gap: 20px; }
        .auth-step.active { display: flex; animation: fadeIn 0.3s ease; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
        
        .auth-close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            border: 1px solid var(--border-subtle); 
            background: var(--surface-light); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            flex-shrink: 0; 
            transition: all 0.2s ease;
        }
        .auth-close-btn:hover { background: var(--surface-hover); }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="page-desktop">
        <nav class="d-navbar">
            <div class="d-navbar-container">
                <img class="d-navbar-logo" src="https://product-ecommerces.netlify.app/vastramaya.png" alt="Vastramaya Logo" />
                <div class="d-nav-links">
                    <a href="#" class="d-nav-link active">Home</a>
                    <a href="#" class="d-nav-link">Shop</a>
                    <div class="d-categories-dropdown">
                        <a href="#" class="d-nav-link">Categories</a>
                        <div class="d-categories-content" id="desktop-nav-categories"></div>
                    </div>
                </div>
                <div class="d-search-container">
                    <svg class="d-search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input type="text" class="d-search-bar" placeholder="Search products..." id="desktop-search">
                </div>
                <div class="d-action-icons">
                    <a href="wishlist.html" class="d-icon-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/></svg>
                        <span class="wishlist-badge" id="wishlist-badge-desktop" style="display:none">0</span>
                    </a>
                    <div class="d-profile-dropdown">
                        <button class="d-icon-btn" id="d-cart-toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg>
                            <span class="cart-badge" id="cart-badge-desktop" style="display:none">0</span>
                        </button>
                        <div class="cart-popup" id="cart-popup">
                            <div class="cart-popup-header">
                                <div class="cart-popup-title">Your Shopping Cart</div>
                                <div class="cart-popup-subtitle" id="cart-count-desktop">0 items</div>
                            </div>
                            <div class="cart-popup-body" id="cart-items-desktop"></div>
                            <div class="cart-popup-footer">
                                <div class="cart-total">
                                    <div class="cart-total-label">Total Amount</div>
                                    <div class="cart-total-amount" id="cart-total-desktop">$0.00</div>
                                </div>
                                <button class="buy-btn" onclick="window.location.href='checkout.html'">
                                    <span>Checkout Now</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="d-profile-dropdown">
                        <button class="d-profile-btn" id="d-profile-toggle">
                            <img class="d-profile-img" id="user-avatar" src="https://ui-avatars.com/api/?name=Guest&background=random" alt="Profile" />
                        </button>
                        <div class="profile-popup" id="profile-popup">
                            <div class="profile-header">
                                <div class="profile-info">
                                    <div class="profile-name" id="user-name">Guest User</div>
                                    <div class="profile-email" id="user-email">Sign in to sync</div>
                                </div>
                            </div>
                            <div class="profile-links" id="profile-links-container">
                                <a href="my-profile.html" class="profile-link auth-only auth-hidden">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    My Profile
                                </a>
                                <a href="my-orders.html" class="profile-link auth-only auth-hidden">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                                    My Orders
                                </a>
                                <div id="login-trigger-desktop" class="profile-link">Sign In</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="d-content">
            <section class="hero-section" id="hero-carousel">
                <div class="carousel-container" id="carousel-container">
                    <div class="carousel-track" id="carousel-track"></div>
                    <div class="carousel-nav">
                        <button class="nav-arrow prev" id="carousel-prev"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                        <button class="nav-arrow next" id="carousel-next"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>
                    <div class="progress-indicators" id="progress-indicators"></div>
                </div>
            </section>

            <section class="best-sellers-section">
                <div class="section-header">
                    <h2>Best Sellers</h2>
                    <div class="section-header-right">
                        <a href="shop.html" class="view-more-link">View More</a>
                        <div class="section-nav">
                            <button class="nav-btn prev-btn" id="best-sellers-prev"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                            <button class="nav-btn next-btn" id="best-sellers-next"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                    </div>
                </div>
                <div class="products-container">
                    <div class="products-grid" id="best-sellers-grid"></div>
                </div>
            </section>

            <section class="categories-section">
                <h2 class="section-title">Shop by Category</h2>
                <div class="categories-container">
                    <div class="categories-grid" id="categories-grid"></div>
                </div>
            </section>
            
            <div id="dynamic-category-sections"></div>
        </main>
    </div>

    <div class="page-mobile">
        <nav class="m-navbar">
            <button class="m-menu-btn" id="m-menu-toggle"><div class="m-menu-lines"><span></span></div></button>
            <img class="m-logo" src="https://product-ecommerces.netlify.app/vastramaya.png" alt="Vastramaya Logo" />
            <div class="m-right-icons">
                <button class="m-icon-btn" id="m-search-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                </button>
                <button class="m-icon-btn" id="m-cart-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 10a4 4 0 0 1-8 0"/><path d="M3.103 6.034h17.794"/><path d="M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z"/></svg>
                    <span class="mobile-cart-badge" id="cart-badge-mobile" style="display:none">0</span>
                </button>
            </div>
        </nav>

        <main class="m-content">
            <div class="m-content-inner">
                <section class="hero-section" id="hero-carousel-mobile">
                    <div class="carousel-container" id="carousel-container-mobile">
                        <div class="carousel-track" id="carousel-track-mobile"></div>
                        <div class="carousel-nav">
                            <button class="nav-arrow prev" id="carousel-prev-mobile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                            <button class="nav-arrow next" id="carousel-next-mobile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                        <div class="progress-indicators" id="progress-indicators-mobile"></div>
                    </div>
                </section>

                <section class="best-sellers-section">
                    <div class="section-header">
                        <h2>Best Sellers</h2>
                        <div class="section-header-right">
                            <a href="shop.html" class="view-more-link">View More</a>
                        </div>
                    </div>
                    <div class="products-container">
                        <div class="products-grid" id="best-sellers-grid-mobile"></div>
                    </div>
                </section>

                <section class="categories-section">
                    <h2 class="section-title">Shop by Category</h2>
                    <div class="categories-container">
                        <div class="categories-grid" id="categories-grid-mobile"></div>
                        <button class="scroll-arrow left hidden" id="scroll-left-mobile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                        <button class="scroll-arrow right" id="scroll-right-mobile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>
                </section>
                
                <div id="dynamic-category-sections-mobile"></div>
            </div>
        </main>

        <div class="m-overlay" id="m-overlay">
            <div class="m-drawer">
                <div class="m-drawer-header">
                    <img class="m-drawer-logo" src="https://product-ecommerces.netlify.app/vastramaya.png" alt="Logo" />
                    <button class="m-drawer-close" id="m-drawer-close"><div class="m-drawer-close-icon"></div></button>
                </div>
                <nav class="m-drawer-nav">
                    <div class="nav-section">
                        <a href="#" class="m-nav-link active">Home</a>
                        <a href="admin.html" id="mobile-admin-link" class="m-nav-link" style="display:none; color: var(--brand-primary);">Admin Dashboard</a>
                        <a href="wishlist.html" class="m-nav-link">
                            Wishlist
                            <span class="mobile-wishlist-badge" id="wishlist-badge-mobile" style="display:none; position:relative; top:0; right:0; margin-left:8px;">0</span>
                        </a>
                        <a href="my-orders.html" class="m-nav-link auth-only auth-hidden">My Orders</a>
                        <div class="m-categories-dropdown">
                            <div class="m-categories-toggle" id="m-categories-toggle">
                                <span>Categories</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron"><path d="m9 18 6-6-6-6"/></svg>
                            </div>
                            <div class="m-categories-content" id="mobile-nav-categories"></div>
                        </div>
                    </div>
                </nav>
                <div class="m-drawer-profile" id="mobile-profile-trigger">
                    <div class="m-profile-popup-menu" id="m-profile-popup">
                         <a href="my-profile.html" class="m-profile-option">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                             My Profile
                         </a>
                         <div class="m-profile-option logout" id="mobile-logout-btn">
                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                             Logout
                         </div>
                    </div>
                    <div class="m-profile-header">
                        <img class="m-profile-img" id="user-avatar-mobile" src="https://ui-avatars.com/api/?name=Guest&background=random" alt="Profile" />
                        <div class="m-profile-info">
                            <div class="m-profile-name" id="user-name-mobile">Guest</div>
                            <div class="m-profile-email" id="user-phone-mobile">
                                <span class="m-login-text">Login / Sign Up</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cart-overlay" id="cart-overlay">
            <div class="cart-drawer">
                <div class="cart-drawer-header">
                    <div class="cart-drawer-title" id="cart-count-mobile">Your Cart (0)</div>
                    <button class="cart-drawer-close" id="cart-drawer-close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <div class="cart-drawer-body" id="cart-items-mobile"></div>
                <div class="cart-drawer-footer">
                    <div class="mobile-cart-total">
                        <div class="mobile-cart-total-label">Total</div>
                        <div class="mobile-cart-total-amount" id="cart-total-mobile">$0.00</div>
                    </div>
                    <button class="mobile-buy-btn" onclick="window.location.href='checkout.html'">
                        <span>Checkout Now</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="m-search-overlay" id="m-search-overlay">
            <div class="m-search-header">
                <input type="text" class="m-search-input" placeholder="Search products..." id="mobile-search">
                <button class="m-search-close" id="m-search-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="auth-modal-content">
            <button class="auth-close-btn" onclick="closeAuthModal()">
                <div class="m-drawer-close-icon"></div>
            </button>
            
            <div id="auth-step-1" class="auth-step active">
                <h3 class="auth-title">Welcome</h3>
                <p class="auth-subtitle">Enter your mobile number to continue</p>
                <div class="auth-input-group">
                    <span class="auth-prefix">+91</span>
                    <input type="tel" id="auth-phone" class="auth-input with-prefix" placeholder="Mobile Number" maxlength="10" oninput="validatePhone()">
                </div>
                <button id="btn-send-otp" class="auth-btn" disabled onclick="sendOTP()">Send OTP</button>
            </div>

            <div id="auth-step-2" class="auth-step">
                <h3 class="auth-title">Verification</h3>
                <p class="auth-subtitle">Enter the 6-digit code sent to your number</p>
                <input type="text" id="auth-otp" class="auth-input" placeholder="Enter OTP" maxlength="6" style="text-align:center; letter-spacing:4px; font-weight:700;">
                <button id="btn-verify-otp" class="auth-btn" onclick="verifyOTP()">Verify & Login</button>
                <p class="auth-subtitle" style="margin-top:0; cursor:pointer; color:var(--brand-primary);" onclick="resetAuth()">Change Number</p>
            </div>

            <div id="auth-step-3" class="auth-step">
                <h3 class="auth-title">Almost There!</h3>
                <p class="auth-subtitle">Please tell us your name</p>
                <input type="text" id="auth-name" class="auth-input" placeholder="Your Name">
                <button id="btn-save-name" class="auth-btn" onclick="saveUserName()">Continue</button>
            </div>
            
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-content-box">
            <button class="btn-close-modal" onclick="closeModal()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <div class="modal-scroll-area">
                <div class="modal-container">
                    <div class="gallery-wrapper">
                        <div class="thumbnails" id="thumbContainer"></div>
                        <div class="main-stage"><img id="mainImage" src="" alt="Product"></div>
                    </div>
                    <div class="mobile-gallery" id="mobileGallery"></div>
                    <div class="product-details">
                        <div class="product-header"><h1 class="modal-product-title" id="productTitle"></h1></div>
                        <div class="price-block">
                            <span class="modal-price-current" id="modalPrice"></span>
                            <span class="modal-price-old" id="modalOldPrice"></span>
                        </div>
                        <div class="option-label">Color Variant</div>
                        <div class="color-swatches" id="colorContainer"></div>
                        <div class="option-label">Size</div>
                        <div class="size-selector" id="sizeSelector"></div>
                        <div class="actions-desktop">
                            <button class="btn-secondary btn-buy-now">Buy Now</button>
                            <button class="btn-main btn-add-to-cart">Add to Cart</button>
                        </div>
                    </div>
                </div>
                <div class="mobile-actions-bar">
                    <button class="btn-mobile-cart btn-add-to-cart">Add to Cart</button>
                    <button class="btn-mobile-buy btn-buy-now">Buy Now</button>
                </div>
            </div>
        </div>
    </div>

    <div class="promo-popup-overlay" id="promo-popup">
        <div class="promo-popup-content">
            <button class="promo-close" onclick="document.getElementById('promo-popup').style.display='none'"></button>
            <a id="promo-link" href="#">
                <img id="promo-image" src="" style="width:100%; display:block;" alt="Offer">
            </a>
            <div style="padding:15px; text-align:center;">
                <h3 id="promo-title" style="margin-bottom:5px;"></h3>
                <p id="promo-msg" style="font-size:14px; color:#666;"></p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCdeonH3VytC21F3X6x0rCVCn2xXrGPoug",
            authDomain: "vastramaya---magic.firebaseapp.com",
            projectId: "vastramaya---magic",
            storageBucket: "vastramaya---magic.firebasestorage.app",
            messagingSenderId: "543460072082",
            appId: "1:543460072082:web:f3d1140e8f81ad338ae44b",
            measurementId: "G-E39VNDCFVE"
        };
        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allProducts = [];
        let allCategories = [];
        let activeProduct = null;
        let cart = JSON.parse(localStorage.getItem('vastramaya_cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('vastramaya_wishlist')) || [];
        let galleryInterval;
        let confirmationResult = null;
        let recaptchaVerifier = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            initNavbarUI();
            checkAuth();
            loadHero();
            loadCategories().then(() => {
                loadProducts();
                loadCategorySections();
            });
            loadPopup();
            renderCart();
            updateWishlistUI();
            initCategoriesScroll();
            initNewArrivalsScroll();
        });

        function checkAuth() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                const triggerDesktop = document.getElementById('login-trigger-desktop');
                const triggerMobile = document.getElementById('mobile-profile-trigger');
                const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
                const mProfilePopup = document.getElementById('m-profile-popup');
                const authOnlyLinks = document.querySelectorAll('.auth-only');

                if (user) {
                    syncCartToFirestore(); 
                    syncWishlistToFirestore();
                    
                    const name = user.displayName || 'User';
                    const emailOrPhone = user.phoneNumber || user.email || '';
                    const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=8b2635&color=fff`;

                    authOnlyLinks.forEach(el => el.classList.remove('auth-hidden'));

                    document.getElementById('user-name').textContent = name;
                    document.getElementById('user-email').textContent = emailOrPhone;
                    document.getElementById('user-avatar').src = avatarUrl;
                    
                    triggerDesktop.textContent = "Sign Out";
                    triggerDesktop.onclick = (e) => {
                        e.preventDefault();
                        auth.signOut();
                    };

                    document.getElementById('user-name-mobile').textContent = name;
                    document.getElementById('user-phone-mobile').innerHTML = emailOrPhone;
                    document.getElementById('user-avatar-mobile').src = avatarUrl;
                    
                    triggerMobile.onclick = (e) => {
                        e.stopPropagation();
                        if(e.target.closest('.m-profile-popup-menu')) return;
                        mProfilePopup.classList.toggle('active');
                    }
                    
                    document.addEventListener('click', (e) => {
                         if(!triggerMobile.contains(e.target)) {
                             mProfilePopup.classList.remove('active');
                         }
                    });

                    mobileLogoutBtn.onclick = (e) => {
                        e.preventDefault();
                        auth.signOut();
                    }

                    if (user.email === ADMIN_EMAIL) {
                        const adminBtn = document.createElement('a');
                        adminBtn.href = "admin.html";
                        adminBtn.className = "profile-link admin-link-btn";
                        adminBtn.innerHTML = `Admin Dashboard`;
                        document.getElementById('profile-links-container').prepend(adminBtn);

                        document.getElementById('mobile-admin-link').style.display = 'flex';
                        document.getElementById('mobile-admin-link').href = "admin.html";
                    }
                } else {
                    authOnlyLinks.forEach(el => el.classList.add('auth-hidden'));

                    document.getElementById('user-name').textContent = "Guest User";
                    document.getElementById('user-email').textContent = "Sign in to sync";
                    document.getElementById('user-avatar').src = "https://ui-avatars.com/api/?name=Guest&background=random";
                    
                    triggerDesktop.textContent = "Sign In / Sign Up";
                    triggerDesktop.onclick = (e) => {
                          e.preventDefault();
                          openAuthModal();
                    };
                    document.getElementById('mobile-admin-link').style.display = 'none';

                    document.getElementById('user-name-mobile').textContent = "Guest";
                    document.getElementById('user-phone-mobile').innerHTML = '<span class="m-login-text">Login / Sign Up</span>';
                    document.getElementById('user-avatar-mobile').src = "https://ui-avatars.com/api/?name=Guest&background=random";
                    
                    mProfilePopup.classList.remove('active');

                    triggerMobile.onclick = () => {
                        openAuthModal();
                    }
                }
            });
        }

        function openAuthModal() {
            document.getElementById('authModal').classList.add('active', 'auth-active');
            if(!recaptchaVerifier) {
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });
            }
            resetAuth();
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active', 'auth-active');
        }

        function resetAuth() {
            document.getElementById('auth-step-1').classList.add('active');
            document.getElementById('auth-step-2').classList.remove('active');
            document.getElementById('auth-step-3').classList.remove('active');
            document.getElementById('auth-phone').value = '';
            document.getElementById('auth-otp').value = '';
            document.getElementById('auth-name').value = '';
            document.getElementById('btn-send-otp').disabled = true;
            document.getElementById('btn-send-otp').innerHTML = 'Send OTP';
        }

        function validatePhone() {
            const input = document.getElementById('auth-phone');
            const btn = document.getElementById('btn-send-otp');
            input.value = input.value.replace(/[^0-9]/g, '');
            btn.disabled = input.value.length !== 10;
        }

        function sendOTP() {
            const phone = '+91' + document.getElementById('auth-phone').value;
            const btn = document.getElementById('btn-send-otp');
            
            btn.innerHTML = '<div class="spinner"></div>';
            btn.disabled = true;

            auth.signInWithPhoneNumber(phone, recaptchaVerifier)
                .then((result) => {
                    confirmationResult = result;
                    document.getElementById('auth-step-1').classList.remove('active');
                    document.getElementById('auth-step-2').classList.add('active');
                    btn.innerHTML = 'Send OTP'; 
                    btn.disabled = false;
                }).catch((error) => {
                    console.error(error);
                    showToast("Error sending OTP. Try again.");
                    btn.innerHTML = 'Send OTP';
                    btn.disabled = false;
                });
        }

        function verifyOTP() {
            const code = document.getElementById('auth-otp').value;
            const btn = document.getElementById('btn-verify-otp');
            
            if(code.length !== 6) {
                showToast("Please enter a valid 6-digit OTP");
                return;
            }

            btn.innerHTML = '<div class="spinner"></div>';
            
            confirmationResult.confirm(code).then((result) => {
                const user = result.user;
                if(result.additionalUserInfo.isNewUser) {
                    document.getElementById('auth-step-2').classList.remove('active');
                    document.getElementById('auth-step-3').classList.add('active');
                } else {
                    closeAuthModal();
                    showToast("Login Successful!");
                }
                btn.innerHTML = 'Verify & Login';
            }).catch((error) => {
                showToast("Invalid OTP");
                btn.innerHTML = 'Verify & Login';
            });
        }

        function saveUserName() {
            const name = document.getElementById('auth-name').value;
            if(name.trim() === '') {
                showToast("Please enter your name");
                return;
            }

            const user = auth.currentUser;
            if(user) {
                user.updateProfile({
                    displayName: name
                }).then(() => {
                    db.collection('users').doc(user.uid).set({
                        name: name,
                        phone: user.phoneNumber,
                        email: user.email || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    checkAuth();
                    closeAuthModal();
                    showToast("Welcome, " + name + "!");
                }).catch((error) => {
                    console.error(error);
                    closeAuthModal(); 
                });
            }
        }
        
        async function syncCartToFirestore() {
            if (!currentUser) return;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists && doc.data().cart) {
                    if (cart.length === 0) {
                        cart = doc.data().cart;
                        saveCart(false);
                        renderCart();
                    } else {
                         const dbCart = doc.data().cart || [];
                         cart.forEach(localItem => {
                             const existing = dbCart.find(d => d.id === localItem.id);
                             if (existing) {
                                 existing.quantity = Math.max(existing.quantity, localItem.quantity);
                             } else {
                                 dbCart.push(localItem);
                             }
                         });
                         cart = dbCart;
                         saveCart(true); 
                         renderCart();
                    }
                } else if (cart.length > 0) {
                    saveCart(true);
                }
            } catch (e) { console.error("Sync error", e); }
        }

        async function syncWishlistToFirestore() {
            if (!currentUser) return;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists && doc.data().wishlist) {
                    if (wishlist.length === 0) {
                        wishlist = doc.data().wishlist;
                        saveWishlist(false);
                        updateWishlistUI();
                    } else {
                        // Merge local wishlist with DB wishlist
                        const dbWishlist = doc.data().wishlist || [];
                        const merged = [...new Set([...wishlist, ...dbWishlist])];
                        wishlist = merged;
                        saveWishlist(true);
                        updateWishlistUI();
                    }
                } else if (wishlist.length > 0) {
                    saveWishlist(true);
                }
            } catch (e) { console.error("Wishlist Sync error", e); }
        }
        
        function handleWishlistAction(productId) {
            if (!wishlist.includes(productId)) {
                wishlist.push(productId);
                showToast("Saved to Wishlist");
            } else {
                wishlist = wishlist.filter(id => id !== productId);
                showToast("Removed from Wishlist");
            }
            saveWishlist(true);
            updateWishlistUI();
        }

        function saveWishlist(syncDB) {
            localStorage.setItem('vastramaya_wishlist', JSON.stringify(wishlist));
            if (syncDB && currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    wishlist: wishlist
                }).catch(err => console.log("Error syncing wishlist", err));
            }
        }

        function updateWishlistUI() {
            const count = wishlist.length;
            const badgeDesktop = document.getElementById('wishlist-badge-desktop');
            const badgeMobile = document.getElementById('wishlist-badge-mobile');
            
            if (badgeDesktop) { 
                badgeDesktop.textContent = count; 
                badgeDesktop.style.display = count > 0 ? 'flex' : 'none'; 
            }
            if (badgeMobile) { 
                badgeMobile.textContent = count; 
                badgeMobile.style.display = count > 0 ? 'flex' : 'none'; 
            }
        }

        async function loadHero() {
            try {
                const doc = await db.collection('landingPage').doc('heroSection').get();
                if (!doc.exists || !doc.data().enabled) return;

                const data = doc.data();
                const slides = data.slides.filter(s => s.active);
                
                const track = document.getElementById('carousel-track');
                const trackMob = document.getElementById('carousel-track-mobile');
                const indicators = document.getElementById('progress-indicators');
                const indicatorsMob = document.getElementById('progress-indicators-mobile');

                const generateSlideHTML = (slide, idx, isMobile) => `
                    <div class="carousel-slide ${idx === 0 ? 'active' : ''}" data-slide="${idx + 1}">
                        <img src="${isMobile ? (slide.mobileImage || slide.image) : (slide.desktopImage || slide.image)}" 
                             class="slide-image" style="object-fit:cover;">
                        <div class="glass-overlay"></div>
                    </div>`;

                track.innerHTML = slides.map((s, i) => generateSlideHTML(s, i, false)).join('');
                trackMob.innerHTML = slides.map((s, i) => generateSlideHTML(s, i, true)).join('');

                const generateIndHTML = (idx) => `<div class="progress-indicator ${idx === 0 ? 'active' : ''}" data-slide="${idx + 1}"><div class="progress-fill"></div></div>`;
                const indHTML = slides.map((_, i) => generateIndHTML(i)).join('');
                indicators.innerHTML = indHTML;
                indicatorsMob.innerHTML = indHTML;

                initCarousel('carousel-container', 'carousel-track', 'carousel-prev', 'carousel-next', 'progress-indicators', slides.length, data.settings?.autoplaySpeed || 5000);
                initCarousel('carousel-container-mobile', 'carousel-track-mobile', 'carousel-prev-mobile', 'carousel-next-mobile', 'progress-indicators-mobile', slides.length, data.settings?.autoplaySpeed || 5000);

            } catch (e) { console.error("Hero Error:", e); }
        }

        async function loadCategories() {
            try {
                const snap = await db.collection('categories').get();
                allCategories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const enabledCats = allCategories.filter(c => c.enabled !== false);
                const sectionDoc = await db.collection('landingPage').doc('Sections').get();
                if (sectionDoc.exists && sectionDoc.data().categories) {
                    const orderMap = sectionDoc.data().categories;
                    enabledCats.sort((a,b) => {
                        const oa = orderMap.find(x => x.id === a.name)?.order || 999;
                        const ob = orderMap.find(x => x.id === b.name)?.order || 999;
                        return oa - ob;
                    });
                }

                const renderCat = (c) => `
                    <a href="#" class="category-item">
                        <div class="category-circle">
                            <img src="${c.imageUrl || 'https://via.placeholder.com/150'}" alt="${c.name}">
                        </div>
                        <div class="category-name">${c.name}</div>
                    </a>`;

                const html = enabledCats.map(renderCat).join('');
                document.getElementById('categories-grid').innerHTML = html;
                document.getElementById('categories-grid-mobile').innerHTML = html;
                
                const navLinks = enabledCats.map(c => `<a href="#" class="d-category-item">${c.name}</a>`).join('');
                document.getElementById('desktop-nav-categories').innerHTML = navLinks;
                
                const navLinksMob = enabledCats.map(c => `<a href="#" class="m-category-item">${c.name}</a>`).join('');
                document.getElementById('mobile-nav-categories').innerHTML = navLinksMob;

            } catch (e) { console.error("Category Error:", e); }
        }

        async function loadProducts() {
            try {
                const snap = await db.collection('products').get();
                allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                loadBestSellers();
            } catch (e) { console.error("Product Error:", e); }
        }

        async function loadBestSellers() {
            try {
                const doc = await db.collection('landingPage').doc('Sections').get();
                let productsToShow = [];

                if (doc.exists && doc.data().bestSellers) {
                    const ids = doc.data().bestSellers;
                    productsToShow = ids.map(id => allProducts.find(p => p.id === id)).filter(p => {
                        if (!p) return false;
                        const isProductActive = p.isAvailable !== false;
                        const categoryObj = allCategories.find(c => c.name === p.category);
                        const isCategoryActive = categoryObj ? categoryObj.enabled !== false : true;
                        return isProductActive && isCategoryActive;
                    });
                } else {
                    productsToShow = allProducts.filter(p => p.isAvailable !== false).slice(0, 10);
                }

                const renderCard = (p) => {
                    const img1 = (p.images && p.images[0]) || 'https://via.placeholder.com/300';
                    const img2 = (p.images && p.images[1]) || img1;
                    
                    return `
                    <div class="product-card" onclick="window.location.href='view.html?id=${p.id}'">
                        <div class="product-image-container">
                            <img src="${img1}" class="product-image default-image">
                            <img src="${img2}" class="product-image hover-image">
                            <button class="quick-view-btn" onclick="event.stopPropagation(); openProductModal('${p.id}', 'quickview')">Quick View</button>
                        </div>
                        <div class="product-info">
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-category">${p.category}</p>
                            <div class="product-price">
                                <div class="price-container">
                                    <span class="current-price">${p.price}</span>
                                    <span class="old-price">${p.oldPrice || (p.price * 1.2).toFixed(0)}</span>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <button class="add-to-cart" style="background-color: #fff; border-color: #e8d5c4;" onclick="event.stopPropagation(); handleWishlistAction('${p.id}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3f0b17" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                    </button>
                                    <button class="add-to-cart" onclick="event.stopPropagation(); openProductModal('${p.id}', 'cart')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                };

                const html = productsToShow.map(renderCard).join('');
                document.getElementById('best-sellers-grid').innerHTML = html;
                document.getElementById('best-sellers-grid-mobile').innerHTML = html;
                
                setTimeout(() => {
                    initProductScroll('best-sellers-grid', 'best-sellers-prev', 'best-sellers-next');
                }, 100);

            } catch (e) { console.error("Best Sellers Error:", e); }
        }

        async function loadCategorySections() {
            try {
                const sectionDoc = await db.collection('landingPage').doc('Sections').get();
                if (!sectionDoc.exists) return;
                
                const sectionsData = sectionDoc.data().categories || [];
                const sortedCategories = [];
                
                sectionsData.forEach(sectionItem => {
                    const cat = allCategories.find(c => c.id === sectionItem.id && c.enabled !== false);
                    if (cat && sectionItem.enabled !== false) {
                        sortedCategories.push(cat);
                    }
                });
                
                const desktopContainer = document.getElementById('dynamic-category-sections');
                const mobileContainer = document.getElementById('dynamic-category-sections-mobile');
                
                for (const cat of sortedCategories) {
                    const products = allProducts.filter(p => {
                        const isProductActive = p.isAvailable !== false;
                        const categoryMatch = p.category === cat.name;
                        return categoryMatch && isProductActive;
                    }).slice(0, 6);
                    
                    if (products.length === 0) continue;
                    
                    const renderCard = (p) => {
                        const img1 = (p.images && p.images[0]) || 'https://via.placeholder.com/300';
                        const img2 = (p.images && p.images[1]) || img1;
                        return `
                        <div class="product-card" onclick="window.location.href='view.html?id=${p.id}'">
                            <div class="product-image-container">
                                <img src="${img1}" class="product-image default-image">
                                <img src="${img2}" class="product-image hover-image">
                                <button class="wishlist-btn-top-right" onclick="event.stopPropagation(); handleWishlistAction('${p.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                </button>
                                <button class="quick-view-btn" onclick="event.stopPropagation(); openProductModal('${p.id}', 'quickview')">Quick View</button>
                            </div>
                            <div class="product-info">
                                <h3 class="product-title">${p.name}</h3>
                                <p class="product-category">${p.category}</p>
                                <div class="product-price">
                                    <div class="price-container">
                                        <span class="current-price">${p.price}</span>
                                        <span class="old-price">${p.oldPrice || (p.price * 1.2).toFixed(0)}</span>
                                    </div>
                                    <button class="add-to-cart" onclick="event.stopPropagation(); openProductModal('${p.id}', 'cart')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
                                </div>
                            </div>
                        </div>`;
                    };
                    
                    const sectionHtml = `
                    <section class="category-products-section">
                        <div class="section-header">
                            <h2>${cat.name}</h2>
                            <div class="section-header-right">
                                <a href="shop.html?category=${encodeURIComponent(cat.name)}" class="view-more-link">View More</a>
                                <div class="section-nav">
                                    <button class="nav-btn prev-btn" id="prev-${cat.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                                    <button class="nav-btn next-btn" id="next-${cat.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                                </div>
                            </div>
                        </div>
                        <div class="products-container">
                            <div class="products-grid" id="grid-${cat.id}">
                                ${products.map(renderCard).join('')}
                            </div>
                        </div>
                    </section>`;
                    
                    if (desktopContainer) desktopContainer.insertAdjacentHTML('beforeend', sectionHtml);
                    if (mobileContainer) mobileContainer.insertAdjacentHTML('beforeend', sectionHtml);
                    
                    setTimeout(() => {
                        initProductScroll(`grid-${cat.id}`, `prev-${cat.id}`, `next-${cat.id}`);
                    }, 100);
                }
                
            } catch (e) { console.error("Section Error:", e); }
        }

        window.openProductModal = function(id, mode) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            activeProduct = product;

            document.getElementById('productTitle').textContent = product.name;
            document.getElementById('modalPrice').textContent = `${product.price}`;
            document.getElementById('modalOldPrice').textContent = `${product.oldPrice || (product.price * 1.2).toFixed(0)}`;

            const colorContainer = document.getElementById('colorContainer');
            const sizeSelector = document.getElementById('sizeSelector');
            colorContainer.innerHTML = '';
            sizeSelector.innerHTML = '';

            if (product.colorVariants && product.colorVariants.length > 0) {
                product.colorVariants.forEach((variant, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = `swatch ${index === 0 ? 'active' : ''}`;
                    if(variant.hex && (variant.hex.startsWith('http') || variant.hex.startsWith('data:'))) {
                         swatch.innerHTML = `<img src="${variant.hex}">`;
                    } else {
                         swatch.style.backgroundColor = variant.hex || '#ccc';
                    }
                    swatch.onclick = () => selectVariant(index);
                    colorContainer.appendChild(swatch);
                });
                selectVariant(0);
            } else {
                updateGallery(product.images || []);
                ['S', 'M', 'L', 'XL', 'XXL'].forEach((size, index) => {
                    const btn = document.createElement('button');
                    btn.className = `size-btn ${index === 0 ? 'active' : ''}`;
                    btn.textContent = size;
                    btn.onclick = function() {
                        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    };
                    sizeSelector.appendChild(btn);
                });
            }

            const buyBtns = document.querySelectorAll('.btn-buy-now');
            buyBtns.forEach(btn => {
                btn.style.display = mode === 'cart' ? 'none' : 'block';
                btn.onclick = () => {
                    addToCart(product.id);
                    window.location.href = 'checkout.html';
                };
            });
            
            const addBtns = document.querySelectorAll('.btn-add-to-cart');
            addBtns.forEach(btn => {
                btn.onclick = () => addToCart(product.id);
            });

            document.getElementById('productModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        window.selectVariant = function(index) {
            if (!activeProduct || !activeProduct.colorVariants || !activeProduct.colorVariants[index]) return;
            const variant = activeProduct.colorVariants[index];
            
            document.querySelectorAll('.swatch').forEach((s, i) => {
                if (i === index) s.classList.add('active');
                else s.classList.remove('active');
            });

            const images = (variant.images && variant.images.length > 0) ? variant.images : activeProduct.images || [];
            updateGallery(images);

            const sizeSelector = document.getElementById('sizeSelector');
            sizeSelector.innerHTML = '';
            if (variant.sizes && variant.sizes.length > 0) {
                variant.sizes.forEach((s, i) => {
                    const btn = document.createElement('button');
                    btn.className = `size-btn ${i===0 ? 'active' : ''}`;
                    btn.textContent = s.name;
                    btn.onclick = function() {
                        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    };
                    sizeSelector.appendChild(btn);
                });
            }
        }

        function updateGallery(images) {
            const mainImg = document.getElementById('mainImage');
            const thumbContainer = document.getElementById('thumbContainer');
            const mobileGallery = document.getElementById('mobileGallery');
            if (galleryInterval) clearInterval(galleryInterval);

            mainImg.src = images[0] || 'https://via.placeholder.com/400';
            thumbContainer.innerHTML = images.map((src, i) => `<div class="thumb ${i===0?'active':''}" onclick="setMainImage('${src}', this)"><img src="${src}"></div>`).join('');
            mobileGallery.innerHTML = images.map(src => `<img src="${src}">`).join('');

            if (images.length > 1) {
                let currentIndex = 0;
                galleryInterval = setInterval(() => {
                    currentIndex = (currentIndex + 1) % images.length;
                    mainImg.style.opacity = 0;
                    setTimeout(() => { 
                        mainImg.src = images[currentIndex]; 
                        mainImg.style.opacity = 1; 
                    }, 200);
                    
                    document.querySelectorAll('.thumb').forEach((t, i) => { 
                        if(i === currentIndex) t.classList.add('active');
                        else t.classList.remove('active');
                    });
                    
                    if(mobileGallery) {
                        const imgWidth = mobileGallery.offsetWidth;
                        mobileGallery.scrollTo({ left: currentIndex * imgWidth, behavior: 'smooth' });
                    }
                }, 4000);
            }
        }

        window.setMainImage = function(src, el) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            if (galleryInterval) clearInterval(galleryInterval);
        }

        window.closeModal = function() {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = '';
            if (galleryInterval) clearInterval(galleryInterval);
        }

        async function loadPopup() {
            try {
                const doc = await db.collection('landingPage').doc('HeroPopup').get();
                if (!doc.exists || !doc.data().enabled) return;
                
                const data = doc.data();
                const lastSeen = localStorage.getItem('popupLastSeen');
                const now = Date.now();
                if (data.displayFrequency === 'once_per_day' && lastSeen && (now - lastSeen < 86400000)) return;
                if (data.displayFrequency === 'once_per_session' && sessionStorage.getItem('popupShown')) return;

                setTimeout(() => {
                    document.getElementById('promo-popup').style.display = 'flex';
                    if(data.imageUrl) document.getElementById('promo-image').src = data.imageUrl;
                    if(data.title) document.getElementById('promo-title').textContent = data.title;
                    if(data.message) document.getElementById('promo-msg').textContent = data.message;
                    if(data.buttonLink) document.getElementById('promo-link').href = data.buttonLink;
                    localStorage.setItem('popupLastSeen', now);
                    sessionStorage.setItem('popupShown', 'true');
                }, (data.delayTime || 2) * 1000);
            } catch (e) { console.log(e); }
        }

        function initCarousel(id, trackId, prevId, nextId, indId, count, speed) {
            const track = document.getElementById(trackId);
            if(!track) return;
            let curr = 0;
            const intervalTime = speed || 5000;
            
            function updateIndicators() {
                const indicators = document.getElementById(indId).querySelectorAll('.progress-indicator');
                indicators.forEach((ind, i) => {
                    if (i === curr) {
                        ind.classList.remove('active');
                        void ind.offsetWidth; 
                        ind.classList.add('active');
                    } else {
                        ind.classList.remove('active');
                    }
                });
            }

            document.getElementById(nextId).onclick = () => {
                curr = (curr + 1) % count;
                update();
            };
            document.getElementById(prevId).onclick = () => {
                curr = (curr - 1 + count) % count;
                update();
            };

            function update() {
                track.style.transform = `translateX(-${curr * 100}%)`;
                updateIndicators();
            }
            
            setInterval(() => {
                curr = (curr + 1) % count;
                update();
            }, intervalTime);
            
            if (id.includes('mobile')) {
                let startX = 0;
                let isDragging = false;
                
                track.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX;
                    isDragging = true;
                }, {passive: true});
                
                track.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    const diff = startX - e.changedTouches[0].pageX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0) curr = (curr + 1) % count;
                        else curr = (curr - 1 + count) % count;
                        update();
                    }
                    isDragging = false;
                }, {passive: true});
            }
        }

        function initNavbarUI() {
            const mMenuToggle = document.getElementById('m-menu-toggle');
            const mDrawerClose = document.getElementById('m-drawer-close');
            const mOverlay = document.getElementById('m-overlay');
            const mDrawer = document.querySelector('.m-drawer');

            function toggleDrawer() {
                mOverlay.classList.toggle('open');
                mDrawer.style.transform = mOverlay.classList.contains('open') ? 'translateX(0)' : 'translateX(-100%)';
            }

            if(mMenuToggle) mMenuToggle.onclick = toggleDrawer;
            if(mDrawerClose) mDrawerClose.onclick = toggleDrawer;
            if(mOverlay) mOverlay.onclick = (e) => { if(e.target === mOverlay) toggleDrawer(); };

            const pToggle = document.getElementById('d-profile-toggle');
            const pPopup = document.getElementById('profile-popup');
            if(pToggle) {
                pToggle.onclick = (e) => { e.stopPropagation(); pPopup.classList.toggle('show'); };
                document.onclick = () => pPopup.classList.remove('show');
            }

            const mCatToggle = document.getElementById('m-categories-toggle');
            const mCatContent = document.getElementById('mobile-nav-categories');
            if(mCatToggle) {
                mCatToggle.onclick = () => {
                    mCatContent.style.display = mCatContent.style.display === 'block' ? 'none' : 'block';
                    mCatToggle.classList.toggle('active');
                }
            }

            const dCartToggle = document.getElementById('d-cart-toggle');
            const cartPopup = document.getElementById('cart-popup');
            if (dCartToggle && cartPopup) {
                dCartToggle.onclick = (e) => { e.stopPropagation(); cartPopup.classList.toggle('show'); };
                cartPopup.onclick = (e) => e.stopPropagation();
                document.addEventListener('click', () => cartPopup.classList.remove('show'));
            }

            const mCartToggle = document.getElementById('m-cart-toggle');
            const cartOverlay = document.getElementById('cart-overlay');
            const cartDrawerClose = document.getElementById('cart-drawer-close');
            if (mCartToggle && cartOverlay && cartDrawerClose) {
                mCartToggle.onclick = () => cartOverlay.classList.add('open');
                cartDrawerClose.onclick = () => cartOverlay.classList.remove('open');
                cartOverlay.onclick = (e) => { if(e.target === cartOverlay) cartOverlay.classList.remove('open'); };
            }

            const mSearchToggle = document.getElementById('m-search-toggle');
            const mSearchOverlay = document.getElementById('m-search-overlay');
            const mSearchClose = document.getElementById('m-search-close');
            if(mSearchToggle && mSearchOverlay) {
                mSearchToggle.onclick = () => mSearchOverlay.style.display = 'flex';
                mSearchClose.onclick = () => mSearchOverlay.style.display = 'none';
            }
        }

        function initCategoriesScroll() {
            const categoriesGrid = document.getElementById('categories-grid-mobile');
            const scrollLeftBtn = document.getElementById('scroll-left-mobile');
            const scrollRightBtn = document.getElementById('scroll-right-mobile');
            
            if (!categoriesGrid || !scrollLeftBtn || !scrollRightBtn) return;
            
            const scrollAmount = 150;
            
            scrollLeftBtn.addEventListener('click', () => {
                categoriesGrid.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });
            
            scrollRightBtn.addEventListener('click', () => {
                categoriesGrid.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });
            
            categoriesGrid.addEventListener('scroll', () => {
                const scrollLeft = categoriesGrid.scrollLeft;
                const scrollWidth = categoriesGrid.scrollWidth;
                const clientWidth = categoriesGrid.clientWidth;
                
                scrollLeftBtn.style.opacity = scrollLeft <= 10 ? '0' : '1';
                scrollLeftBtn.style.pointerEvents = scrollLeft <= 10 ? 'none' : 'auto';
                
                scrollRightBtn.style.opacity = scrollLeft + clientWidth >= scrollWidth - 10 ? '0' : '1';
                scrollRightBtn.style.pointerEvents = scrollLeft + clientWidth >= scrollWidth - 10 ? 'none' : 'auto';
            });
        }

        function initNewArrivalsScroll() {
            initProductScroll('best-sellers-grid', 'best-sellers-prev', 'best-sellers-next');
            initProductScroll('best-sellers-grid-mobile', 'best-sellers-prev-mobile', 'best-sellers-next-mobile');
        }

        function initProductScroll(gridId, prevBtnId, nextBtnId) {
            const grid = document.getElementById(gridId);
            const prev = document.getElementById(prevBtnId);
            const next = document.getElementById(nextBtnId);
            if (!grid || !prev || !next) return;

            const scrollAmount = 300;

            prev.addEventListener('click', () => {
                grid.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });

            next.addEventListener('click', () => {
                grid.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            let selectedSize = null;
            let selectedColor = null;
            let selectedImage = (product.images && product.images[0]) || 'https://via.placeholder.com/70';

            // Check if we are adding from the modal (activeProduct matches)
            if (activeProduct && activeProduct.id === productId && document.getElementById('productModal').classList.contains('active')) {
                // Get Size
                const activeSizeBtn = document.querySelector('.size-selector .size-btn.active');
                if (activeSizeBtn) selectedSize = activeSizeBtn.textContent;

                // Get Color
                const activeSwatch = document.querySelector('.color-swatches .swatch.active');
                if (activeSwatch) {
                    const swatches = Array.from(document.querySelectorAll('.color-swatches .swatch'));
                    const colorIndex = swatches.indexOf(activeSwatch);
                    if (colorIndex >= 0 && product.colorVariants && product.colorVariants[colorIndex]) {
                        selectedColor = product.colorVariants[colorIndex].name || product.colorVariants[colorIndex].hex;
                        if (product.colorVariants[colorIndex].images && product.colorVariants[colorIndex].images[0]) {
                            selectedImage = product.colorVariants[colorIndex].images[0];
                        }
                    }
                }
            }

            const uniqueId = `${product.id}-${selectedColor||'def'}-${selectedSize||'def'}`;

            const existingItem = cart.find(item => item.uniqueId === uniqueId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    uniqueId: uniqueId,
                    name: product.name,
                    price: product.price,
                    image: selectedImage,
                    quantity: 1,
                    size: selectedSize,
                    color: selectedColor
                });
            }
            saveCart(true); 
            renderCart();
            showToast("Item added to cart");
            closeModal();
        }

        function removeFromCart(uniqueId) {
            cart = cart.filter(item => item.uniqueId !== uniqueId);
            saveCart(true);
            renderCart();
        }

        function updateQuantity(uniqueId, change) {
            const item = cart.find(item => item.uniqueId === uniqueId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(uniqueId);
                } else {
                    saveCart(true);
                    renderCart();
                }
            }
        }

        function saveCart(syncDB) {
            localStorage.setItem('vastramaya_cart', JSON.stringify(cart));
            if (syncDB && currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    cart: cart
                }).catch(err => console.log("Error syncing cart", err));
            }
        }

        function renderCart() {
            const desktopBody = document.getElementById('cart-items-desktop');
            const mobileBody = document.getElementById('cart-items-mobile');
            const badgeDesktop = document.getElementById('cart-badge-desktop');
            const badgeMobile = document.getElementById('cart-badge-mobile');
            const totalDesktop = document.getElementById('cart-total-desktop');
            const totalMobile = document.getElementById('cart-total-mobile');
            const countDesktop = document.getElementById('cart-count-desktop');
            const countMobile = document.getElementById('cart-count-mobile');

            let total = 0;
            let count = 0;
            let html = '';

            if (cart.length === 0) {
                html = '<div class="empty-cart-msg">Your cart is empty</div>';
            } else {
                cart.forEach(item => {
                    // Backward compatibility fix for items without uniqueId
                    if(!item.uniqueId) item.uniqueId = item.id;
                    
                    total += item.price * item.quantity;
                    count += item.quantity;
                    html += `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                            <div class="cart-item-details">
                                <div class="cart-item-title">${item.name}</div>
                                <div style="font-size:12px; color:var(--text-light); margin-bottom:4px;">
                                    ${item.color ? `Color: ${item.color}` : ''} 
                                    ${item.size ? `Size: ${item.size}` : ''}
                                </div>
                                <div class="cart-item-price">${item.price}</div>
                                <div class="cart-item-quantity">
                                    <div class="quantity-btn" onclick="updateQuantity('${item.uniqueId}', -1)">-</div>
                                    <div class="quantity-value">${item.quantity}</div>
                                    <div class="quantity-btn" onclick="updateQuantity('${item.uniqueId}', 1)">+</div>
                                </div>
                            </div>
                            <div class="cart-item-remove" onclick="removeFromCart('${item.uniqueId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </div>
                        </div>
                    `;
                });
            }

            if (desktopBody) desktopBody.innerHTML = html;
            if (mobileBody) mobileBody.innerHTML = html;

            if (badgeDesktop) { badgeDesktop.textContent = count; badgeDesktop.style.display = count > 0 ? 'flex' : 'none'; }
            if (badgeMobile) { badgeMobile.textContent = count; badgeMobile.style.display = count > 0 ? 'flex' : 'none'; }

            if (totalDesktop) totalDesktop.textContent = `${total.toFixed(2)}`;
            if (totalMobile) totalMobile.textContent = `${total.toFixed(2)}`;
            
            if (countDesktop) countDesktop.textContent = `${count} item${count !== 1 ? 's' : ''}`;
            if (countMobile) countMobile.textContent = `Your Cart (${count})`;
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4a9c7d" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>${msg}</span>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>
